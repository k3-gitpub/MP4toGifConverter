<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>MP4 to GIF Converter</title>
    <!-- noUiSlider CSS for range slider -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css" integrity="sha512-qveKnGrvOChbSzAdtSs8p69eoLegyh+1hwOMbmpCViIwj7rn4oJjdmMvWOuyQlTOZgTlZA0N2PXA7iA8/2TUYA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; max-width: 600px; margin: auto; padding: 20px; background-color: #f8f9fa; }
        h1 { color: #343a40; }
        .card {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        #preview-container {
            display: none; /* Hide until a file is selected */
        }
        form { display: flex; flex-direction: column; gap: 15px; }
        .form-group { display: flex; flex-direction: column; }
        label { margin-bottom: 5px; font-weight: bold; color: #495057; }
        input, button { padding: 10px; font-size: 16px; border-radius: 4px; border: 1px solid #ced4da; }
        button { background-color: #007bff; color: white; border: none; cursor: pointer; transition: background-color 0.2s; }
        button:hover { background-color: #0056b3; }
        #status { margin-top: 20px; padding: 10px; border-radius: 5px; display: none; font-weight: 500; }
        .info { background-color: #e2e3e5; color: #383d41; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        #result { margin-top: 20px; text-align: center; }
        #result img { max-width: 100%; border-radius: 4px; border: 1px solid #ddd; }
        #result a { display: inline-block; margin-top: 10px; padding: 8px 16px; background-color: #28a745; color: white; text-decoration: none; border-radius: 4px; }
        .privacy-note { text-align: center; font-size: 13px; color: #6c757d; margin-top: 5px; margin-bottom: 20px; }
        #slider-container {
            margin: 30px 10px 30px 10px;
        }
        /* Custom styles for noUiSlider */
        .noUi-connect { background: #007bff; }
        .noUi-tooltip { font-size: 12px; padding: 2px 4px; }
        /* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ãƒãƒ³ãƒ‰ãƒ«ã®è‰²åˆ†ã‘ */
        .noUi-handle.noUi-handle-lower {
            background: #28a745; /* é–‹å§‹ãƒãƒ³ãƒ‰ãƒ« (ç·‘) */
            border: 1px solid #1f7a33;
            cursor: grab;
        }
        .noUi-handle.noUi-handle-upper {
            background: #dc3545; /* çµ‚äº†ãƒãƒ³ãƒ‰ãƒ« (èµ¤) */
            border: 1px solid #a71d2a;
            cursor: grab;
        }
        .noUi-handle:focus { outline: none; }
        /* è¿½åŠ : é¸æŠç¯„å›²ã®æ™‚é–“ã‚’è¡¨ç¤ºã™ã‚‹ã‚¹ã‚¿ã‚¤ãƒ« */
        .duration-display {
            text-align: center;
            margin-top: 15px;
            font-weight: bold;
            color: #343a40;
        }
    </style>
</head>
<body>
    <h1>MP4 to GIF Converter</h1>

    <div id="preview-container" class="card">
        <h3>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ &amp; ç¯„å›²é¸æŠ</h3>
        <video id="video-preview" controls width="100%" muted></video>
        <div id="duration-display" class="duration-display"></div>
        <div id="slider-container"></div>
    </div>

    <div class="card">
        <form id="upload-form">
            <div class="form-group">
                <label for="file">1. MP4 ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ:</label>
                <input type="file" id="file" name="file" accept=".mp4" required>
            </div>
            <div class="form-group">
                <label for="start_time">2. é–‹å§‹æ™‚é–“ (ç§’):</label>
                <input type="number" id="start_time" name="start_time" value="0" step="0.01" class="form-control">
            </div>
            <div class="form-group">
                <label for="end_time">3. çµ‚äº†æ™‚é–“ (ç§’):</label>
                <input type="number" id="end_time" name="end_time" placeholder="å‹•ç”»ã®æœ€å¾Œã¾ã§" step="0.01" class="form-control">
            </div>
            <div class="form-group">
                <label for="fps">4. ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆ (FPS):</label>
                <input type="number" id="fps" name="fps" value="15" class="form-control">
            </div>
            <div class="form-group">
                <label for="width">5. å¹… (px):</label>
                <input type="number" id="width" name="width" value="640" class="form-control">
            </div>
            <div class="form-group" style="flex-direction: row; align-items: center; gap: 10px;">
                <input type="checkbox" id="high_quality" name="high_quality" value="true" style="width: auto;">
                <label for="high_quality" style="margin-bottom: 0;">é«˜å“è³ªãƒ¢ãƒ¼ãƒ‰ (è‰²ã‚’ç¶ºéº—ã«ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚’æœ€é©åŒ–)</label>
            </div>
            <button type="submit">GIFã«å¤‰æ›</button>
        </form>
    </div>
    <p class="privacy-note">
        ğŸ”’ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€å¤‰æ›ã¨ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ãŸå¾Œã«ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰è‡ªå‹•çš„ã«å‰Šé™¤ã•ã‚Œã¾ã™ã€‚
    </p>
    <div id="status"></div>
    <div id="progress-container" style="display: none; margin-top: 10px;">
        <progress id="progress-bar" value="0" max="100" style="width: 100%;"></progress>
    </div>
    <div id="result"></div>

    <!-- noUiSlider JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js" integrity="sha512-UOJe4paV6hYWBnS0c9GnIRH8PLm2nFK22uhfAvsTIqd3uwnWsVri1OPn5fJYdLtGY3wB11LGHJ4yPU1WFJeBYQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script>
    // â˜…â˜…â˜… è§£æ±ºç­–: ãƒšãƒ¼ã‚¸å…¨ä½“ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã‹ã‚‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ â˜…â˜…â˜…
    // ã“ã‚Œã«ã‚ˆã‚Šã€noUiSliderãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒç¢ºå®Ÿã«åˆ©ç”¨å¯èƒ½ãªçŠ¶æ…‹ã«ãªã‚Šã¾ã™ã€‚
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('upload-form');
        const statusDiv = document.getElementById('status');
        const resultDiv = document.getElementById('result');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        
        const fileInput = document.getElementById('file');
        const startTimeInput = document.getElementById('start_time');
        const endTimeInput = document.getElementById('end_time');
        const previewContainer = document.getElementById('preview-container');
        const videoPreview = document.getElementById('video-preview');
        const sliderContainer = document.getElementById('slider-container');
        let rangeSlider = null; // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä¿æŒ
        let currentVideoDuration = 0; // å‹•ç”»ã®é•·ã•ã‚’ä¿æŒ
        let isSliderSetup = false; // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ãŒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ¸ˆã¿ã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚°
        const durationDisplay = document.getElementById('duration-display');

        /**
         * â˜…â˜…â˜… è¿½åŠ : é¸æŠã•ã‚ŒãŸæ™‚é–“ã®é•·ã•ã‚’è¨ˆç®—ã—ã¦è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•° â˜…â˜…â˜…
         */
        function updateDurationDisplay() {
            const startTime = parseFloat(startTimeInput.value);
            
            // endTimeInputãŒç©ºã¾ãŸã¯ç„¡åŠ¹ãªå ´åˆã¯å‹•ç”»ã®å…¨é•·ã‚’ä½¿ç”¨
            const endTimeValue = endTimeInput.value.trim();
            const endTime = (endTimeValue === '' || isNaN(parseFloat(endTimeValue))) 
                            ? currentVideoDuration 
                            : parseFloat(endTimeValue);

            if (!isNaN(startTime) && !isNaN(endTime) && endTime >= startTime) {
                const duration = endTime - startTime;
                durationDisplay.textContent = `é¸æŠç¯„å›²: ${duration.toFixed(2)}ç§’`;
            } else {
                durationDisplay.textContent = 'é¸æŠç¯„å›²: 0.00ç§’';
            }
        }

        /**
         * ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã¨é–¢é€£ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹é–¢æ•°
         */
        function setupSliderAndEvents() {
            const duration = videoPreview.duration;
            if (!duration || !isFinite(duration)) {
                // durationãŒä¸æ­£ãªå ´åˆã¯ä½•ã‚‚ã—ãªã„
                console.error("Invalid video duration:", duration);
                return;
            }
            currentVideoDuration = duration;

            // æ—¢ã«ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ç ´æ£„
            if (rangeSlider) {
                rangeSlider.destroy();
            }

            // å…¥åŠ›æ¬„ã‚’åˆæœŸåŒ–
            startTimeInput.value = "0.00";
            endTimeInput.value = ""; // æœ€å¾Œã¾ã§ãªã®ã§ç©ºã«ã™ã‚‹
            endTimeInput.placeholder = `å‹•ç”»ã®æœ€å¾Œã¾ã§ (${duration.toFixed(2)}s)`;

            // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’ç”Ÿæˆ
            rangeSlider = noUiSlider.create(sliderContainer, {
                start: [0, duration],
                connect: true,
                range: { 'min': 0, 'max': duration },
                tooltips: [
                    { to: value => parseFloat(value).toFixed(1) + 's' },
                    { to: value => parseFloat(value).toFixed(1) + 's' }
                ]
            });

            // --- ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã¨å…¥åŠ›æ¬„ã®åŒæ–¹å‘é€£æº ---
            rangeSlider.on('update', (values, handle) => {
                const startTime = parseFloat(values[0]);
                const endTime = parseFloat(values[1]);

                startTimeInput.value = startTime.toFixed(2);
                if (Math.abs(endTime - currentVideoDuration) < 0.1) {
                    endTimeInput.value = '';
                } else {
                    endTimeInput.value = endTime.toFixed(2);
                }
                // â˜…â˜…â˜… è¿½åŠ : ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼æ›´æ–°æ™‚ã«é¸æŠæ™‚é–“ã‚’è¡¨ç¤º â˜…â˜…â˜…
                updateDurationDisplay();
            });

            // --- ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã¨å‹•ç”»ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®é€£æº ---
            rangeSlider.on('slide', (values, handle) => {
                videoPreview.currentTime = parseFloat(values[handle]);
            });

            // --- å…¥åŠ›æ¬„ã‹ã‚‰ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã¸ã®é€£æº ---
            startTimeInput.addEventListener('change', function() {
                rangeSlider.set([this.value, null]);
                // â˜…â˜…â˜… è¿½åŠ : å…¥åŠ›æ¬„å¤‰æ›´æ™‚ã«é¸æŠæ™‚é–“ã‚’è¡¨ç¤º â˜…â˜…â˜…
                updateDurationDisplay();
            });

            endTimeInput.addEventListener('change', function() {
                rangeSlider.set([null, this.value === '' ? currentVideoDuration : this.value]);
                // â˜…â˜…â˜… è¿½åŠ : å…¥åŠ›æ¬„å¤‰æ›´æ™‚ã«é¸æŠæ™‚é–“ã‚’è¡¨ç¤º â˜…â˜…â˜…
                updateDurationDisplay();
            });

            // â˜…â˜…â˜… è¿½åŠ : ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ™‚ã«åˆæœŸè¡¨ç¤º â˜…â˜…â˜…
            updateDurationDisplay();
        }

        // â˜…â˜…â˜… è§£æ±ºç­–: å‹•ç”»ã®é•·ã•ãŒç¢ºå®šã—ãŸç¬é–“ã«ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’ä½œæˆã™ã‚‹ã€ã‚ˆã‚Šå …ç‰¢ãªæ–¹æ³•ã§ã™ã€‚â˜…â˜…â˜…
        // 'durationchange' ã‚¤ãƒ™ãƒ³ãƒˆã¯ã€å‹•ç”»ã®é•·ã•(duration)ãŒå¤‰æ›´ã•ã‚ŒãŸã¨ãã«ç™ºç”Ÿã—ã¾ã™ã€‚
        // ã“ã‚Œã«ã‚ˆã‚Šã€é•·ã•ãŒ 'NaN' ã‚„ '0' ã‹ã‚‰å®Ÿéš›ã®é•·ã•ã«ç¢ºå®šã—ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’æ­£ç¢ºã«æ‰ãˆã‚‰ã‚Œã¾ã™ã€‚
        videoPreview.addEventListener('durationchange', () => {
            // å‹•ç”»ã®é•·ã•ãŒ0ã‚ˆã‚Šå¤§ããã€ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ãŒã¾ã ä½œã‚‰ã‚Œã¦ã„ãªã„å ´åˆã®ã¿å®Ÿè¡Œ
            if (videoPreview.duration > 0 && !isSliderSetup) {
                isSliderSetup = true; // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã€äºŒé‡å®Ÿè¡Œã‚’é˜²ã
                setupSliderAndEvents();
            }
        });

        // ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚ŒãŸã¨ãã®å‡¦ç†
        fileInput.addEventListener('change', () => {
            const file = fileInput.files[0];
            if (file) {
                isSliderSetup = false; // æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚ŒãŸã®ã§ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
                if (videoPreview.src) {
                    URL.revokeObjectURL(videoPreview.src); // å¤ã„URLã‚’è§£æ”¾
                }
                const videoURL = URL.createObjectURL(file);
                videoPreview.src = videoURL;
                previewContainer.style.display = 'block';
            }
        });

        // ã‚µãƒ¼ãƒãƒ¼ã«ã‚¿ã‚¹ã‚¯ã®çŠ¶æ³ã‚’å•ã„åˆã‚ã›ã‚‹é–¢æ•°
        function pollStatus(statusUrl) {
            const intervalId = setInterval(async () => {
                try {
                    const response = await fetch(statusUrl);
                    if (!response.ok) {
                        statusDiv.className = 'error';
                        statusDiv.textContent = `ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸ: ${response.statusText}`;
                        clearInterval(intervalId);
                        return;
                    }

                    const data = await response.json();

                    if (data.state === 'SUCCESS') {
                        clearInterval(intervalId);
                        progressContainer.style.display = 'none';
                        statusDiv.className = 'success';
                        statusDiv.textContent = 'å¤‰æ›å®Œäº†ï¼GIFã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...';

                        // fetch APIã‚’ä½¿ã£ã¦GIFãƒ‡ãƒ¼ã‚¿ã‚’ä¸€åº¦ã ã‘å–å¾—ã—ã¾ã™
                        const gifResponse = await fetch(data.download_url);
                        const blob = await gifResponse.blob();
                        // å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ãƒ–ãƒ©ã‚¦ã‚¶å†…ã®ä¸€æ™‚çš„ãªURLã‚’ç”Ÿæˆã—ã¾ã™
                        const objectURL = URL.createObjectURL(blob);

                        statusDiv.textContent = 'å¤‰æ›ãŒå®Œäº†ã—ã¾ã—ãŸï¼';
                        resultDiv.innerHTML = `<img src="${objectURL}" alt="Converted GIF"><br><a href="${objectURL}" download="converted.gif">GIFã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</a>`;
                    } else if (data.state === 'FAILURE') {
                        clearInterval(intervalId);
                        progressContainer.style.display = 'none';
                        statusDiv.className = 'error';
                        statusDiv.textContent = `ã‚¨ãƒ©ãƒ¼: å¤‰æ›ã«å¤±æ•—ã—ã¾ã—ãŸã€‚è©³ç´°: ${data.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`;
                    } else if (data.state === 'PROGRESS') {
                        statusDiv.textContent = `å¤‰æ›ä¸­ã§ã™... ${data.progress}%`;
                        progressBar.value = data.progress;
                        progressContainer.style.display = 'block';
                    } else {
                        // PENDING, STARTED, RETRY...
                        progressContainer.style.display = 'none';
                        statusDiv.className = 'info';
                        statusDiv.textContent = `å¤‰æ›ä¸­ã§ã™... (ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${data.state})`;
                    }
                } catch (error) {
                    statusDiv.className = 'error';
                    statusDiv.textContent = `ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ç¢ºèªä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error}`;
                    clearInterval(intervalId);
                }
            }, 2000); // 2ç§’ã”ã¨ã«çŠ¶æ³ã‚’ç¢ºèª
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            statusDiv.style.display = 'block';
            statusDiv.className = 'info';
            statusDiv.textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã„ã¾ã™...';
            progressContainer.style.display = 'none';
            progressBar.value = 0;
            resultDiv.innerHTML = '';

            const formData = new FormData(form);
            try {
                const response = await fetch('/convert', { method: 'POST', body: formData });

                if (response.status === 202) {
                    const data = await response.json();
                    statusDiv.textContent = 'å¤‰æ›ã‚¿ã‚¹ã‚¯ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸã€‚å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™...';
                    pollStatus(data.status_url);
                } else {
                    const errorData = await response.json();
                    statusDiv.className = 'error';
                    statusDiv.textContent = `ã‚¨ãƒ©ãƒ¼: ${errorData.error}. è©³ç´°: ${errorData.details || 'N/A'}`;
                }
            } catch (error) {
                statusDiv.className = 'error';
                statusDiv.textContent = `ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error}`;
            }
        });
    });
    </script>
    <footer style="text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 14px; color: #6c757d;">
        <p>Powered by Open Source Software. <a href="/licenses">Licenses</a></p>
    </footer>
</body>
</html>