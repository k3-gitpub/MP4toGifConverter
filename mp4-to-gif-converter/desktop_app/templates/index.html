<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>MP4 to GIF Converter</title>
    <!-- noUiSlider CSS for range slider -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css" integrity="sha512-qveKnGrvOChbSzAdtSs8p69eoLegyh+1hwOMbmpCViIwj7rn4oJjdmMvWOuyQlTOZgTlZA0N2PXA7iA8/2TUYA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; max-width: 960px; margin: auto; padding: 20px; background-color: #f8f9fa; }
        h1 { color: #343a40; }
        .card {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        #preview-container {
            display: none; /* Hide until a file is selected */
        }
        form { display: flex; flex-direction: column; gap: 15px; }
        .form-group { display: flex; flex-direction: column; }
        label { margin-bottom: 5px; font-weight: bold; color: #495057; }
        input, button { padding: 10px; font-size: 16px; border-radius: 4px; border: 1px solid #ced4da; }
        button { background-color: #007bff; color: white; border: none; cursor: pointer; transition: background-color 0.2s; }
        button:hover { background-color: #0056b3; }
        #status { margin-top: 20px; padding: 10px; border-radius: 5px; display: none; font-weight: 500; }
        .info { background-color: #e2e3e5; color: #383d41; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        #result { margin-top: 20px; text-align: center; }
        #result img { max-width: 100%; border-radius: 4px; border: 1px solid #ddd; }
        #result a { display: inline-block; margin-top: 10px; padding: 8px 16px; background-color: #28a745; color: white; text-decoration: none; border-radius: 4px; }
        .privacy-note { text-align: center; font-size: 13px; color: #6c757d; margin-top: 5px; margin-bottom: 20px; }
        #slider-container {
            margin: 30px 10px 30px 10px;
        }
        /* Custom styles for noUiSlider */
        .noUi-connect { background: #007bff; }
        .noUi-tooltip { font-size: 12px; padding: 2px 4px; }
        /* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ãƒãƒ³ãƒ‰ãƒ«ã®è‰²åˆ†ã‘ */
        .noUi-handle.noUi-handle-lower {
            background: #28a745; /* é–‹å§‹ãƒãƒ³ãƒ‰ãƒ« (ç·‘) */
            border: 1px solid #1f7a33;
            cursor: grab;
        }
        .noUi-handle.noUi-handle-upper {
            background: #dc3545; /* çµ‚äº†ãƒãƒ³ãƒ‰ãƒ« (èµ¤) */
            border: 1px solid #a71d2a;
            cursor: grab;
        }
        .noUi-handle:focus { outline: none; }
        /* è¿½åŠ : ãƒ•ã‚¡ã‚¤ãƒ«/ãƒ•ã‚©ãƒ«ãƒ€é¸æŠUIã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .file-input-container { display: flex; gap: 10px; align-items: center; }
        .file-input-container input[type="text"] { flex-grow: 1; }
        .file-input-container button { flex-shrink: 0; }
        input:read-only { background-color: #e9ecef; cursor: default; }
        /* è¿½åŠ : é¸æŠç¯„å›²ã®æ™‚é–“ã‚’è¡¨ç¤ºã™ã‚‹ã‚¹ã‚¿ã‚¤ãƒ« */
        .duration-display {
            text-align: center;
            margin-top: 15px;
            font-weight: bold;
            color: #343a40;
        }
    </style>
</head>
<body>
    <h1>MP4 to GIF Converter</h1>

    <div id="preview-container" class="card">
        <h3>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ &amp; ç¯„å›²é¸æŠ</h3>
        <video id="video-preview" controls width="100%" muted></video>
        <div id="duration-display" class="duration-display"></div>
        <div id="slider-container"></div>
    </div>

    <div class="card">
        <form id="upload-form">
            <div class="form-group">
                <label>1. MP4 ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ:</label>
                <div class="file-input-container">
                    <input type="text" id="selected-file-path" placeholder="ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“" readonly>
                    <button type="button" id="select-file-button">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ...</button>
                </div>
                <!-- ã“ã®inputè¦ç´ ã¯ç¾åœ¨ç›´æ¥ã¯ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã›ã‚“ãŒã€å°†æ¥ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã®ãŸã‚ã«æ®‹ã—ã¦ãŠãã¾ã™ -->
                <input type="file" id="file" name="file" accept=".mp4" style="display: none;">
            </div>
            <div class="form-group">
                <label for="output-dir">2. ä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€:</label>
                <div class="file-input-container">
                    <input type="text" id="output-dir" name="output_dir" placeholder="ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: outputsãƒ•ã‚©ãƒ«ãƒ€ï¼‰" readonly>
                    <button type="button" id="select-dir-button">ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠ...</button>
                </div>
            </div>
            <div class="form-group">
                <label for="output-filename">3. ä¿å­˜ãƒ•ã‚¡ã‚¤ãƒ«å:</label>
                <input type="text" id="output-filename" name="output_filename" placeholder="ï¼ˆæŒ‡å®šãªã—ã®å ´åˆã¯ å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«å.gifï¼‰">
            </div>
            <hr style="margin: 20px 0;">
            <div class="form-group">
                <label for="start_time">é–‹å§‹æ™‚é–“ (ç§’):</label>
                <input type="number" id="start_time" name="start_time" value="0" step="0.01" class="form-control">
            </div>
            <div class="form-group">
                <label for="end_time">çµ‚äº†æ™‚é–“ (ç§’):</label>
                <input type="number" id="end_time" name="end_time" placeholder="å‹•ç”»ã®æœ€å¾Œã¾ã§" step="0.01" class="form-control">
            </div>
            <div class="form-group">
                <label for="fps">ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆ (FPS):</label>
                <input type="number" id="fps" name="fps" value="15" class="form-control">
            </div>
            <div class="form-group">
                <label for="width">å¹… (px):</label>
                <input type="number" id="width" name="width" value="640" class="form-control">
            </div>
            <div class="form-group" style="flex-direction: row; align-items: center; gap: 10px;">
                <input type="checkbox" id="high_quality" name="high_quality" value="true" style="width: auto;">
                <label for="high_quality" style="margin-bottom: 0;">é«˜å“è³ªãƒ¢ãƒ¼ãƒ‰ (è‰²ã‚’ç¶ºéº—ã«ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚’æœ€é©åŒ–)</label>
            </div>
            <button type="submit">GIFã«å¤‰æ›</button>
        </form>
    </div>
    <p class="privacy-note">
        ğŸ”’ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€å¤‰æ›ã¨ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ãŸå¾Œã«ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰è‡ªå‹•çš„ã«å‰Šé™¤ã•ã‚Œã¾ã™ã€‚
    </p>
    <div id="status"></div>
    <div id="progress-container" style="display: none; margin-top: 10px;">
        <progress id="progress-bar" value="0" max="100" style="width: 100%;"></progress>
    </div>
    <div id="result"></div>

    <!-- noUiSlider JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js" integrity="sha512-UOJe4paV6hYWBnS0c9GnIRH8PLm2nFK22uhfAvsTIqd3uwnWsVri1OPn5fJYdLtGY3wB11LGHJ4yPU1WFJeBYQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script>
    // â˜…â˜…â˜… è§£æ±ºç­–: pywebviewã®APIãŒæº–å‚™å®Œäº†ã—ãŸã“ã¨ã‚’ç¤ºã™ 'pywebviewready' ã‚¤ãƒ™ãƒ³ãƒˆã‚’å¾…ã¡ã¾ã™ã€‚â˜…â˜…â˜…
    // ã“ã‚Œã«ã‚ˆã‚Šã€`window.pywebview.api` ãŒæœªå®šç¾©ã§ã‚ã‚‹ã¨ã„ã†ã‚¨ãƒ©ãƒ¼ã‚’é˜²ãã¾ã™ã€‚
    window.addEventListener('pywebviewready', async function() {
        const form = document.getElementById('upload-form');
        const statusDiv = document.getElementById('status');
        const resultDiv = document.getElementById('result');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        
        const fileInput = document.getElementById('file');
        const startTimeInput = document.getElementById('start_time');
        const endTimeInput = document.getElementById('end_time');
        const previewContainer = document.getElementById('preview-container');
        const videoPreview = document.getElementById('video-preview');
        const sliderContainer = document.getElementById('slider-container');
        let rangeSlider = null; // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä¿æŒ
        const durationDisplay = document.getElementById('duration-display'); // â˜…â˜…â˜… è¿½åŠ  â˜…â˜…â˜…

        // --- ã‚¹ãƒ†ãƒƒãƒ—Aã§è¿½åŠ ã—ãŸUIè¦ç´  ---
        const selectFileButton = document.getElementById('select-file-button');
        const selectedFilePathInput = document.getElementById('selected-file-path');
        const outputFilenameInput = document.getElementById('output-filename');
        const outputDirInput = document.getElementById('output-dir');
        const selectDirButton = document.getElementById('select-dir-button');

        let currentVideoDuration = 0; // å‹•ç”»ã®é•·ã•ã‚’ä¿æŒ
        let isSliderSetup = false; // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ãŒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ¸ˆã¿ã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚°

        // --- ã‚¹ãƒ†ãƒƒãƒ—C: æœ€å¾Œã«ä½¿ç”¨ã—ãŸä¿å­˜å…ˆã‚’èª­ã¿è¾¼ã‚€ ---
        try {
            const lastOutputDir = await window.pywebview.api.get_last_output_dir();
            if (lastOutputDir) {
                outputDirInput.value = lastOutputDir;
            }
        } catch (e) {
            console.error("Could not load last used paths:", e);
        }

        /**
         * â˜…â˜…â˜… è¿½åŠ : é¸æŠã•ã‚ŒãŸæ™‚é–“ã®é•·ã•ã‚’è¨ˆç®—ã—ã¦è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•° â˜…â˜…â˜…
         */
        function updateDurationDisplay() {
            const startTime = parseFloat(startTimeInput.value);
            
            // endTimeInputãŒç©ºã¾ãŸã¯ç„¡åŠ¹ãªå ´åˆã¯å‹•ç”»ã®å…¨é•·ã‚’ä½¿ç”¨
            const endTimeValue = endTimeInput.value.trim();
            const endTime = (endTimeValue === '' || isNaN(parseFloat(endTimeValue))) 
                            ? currentVideoDuration 
                            : parseFloat(endTimeValue);

            if (!isNaN(startTime) && !isNaN(endTime) && endTime >= startTime) {
                const duration = endTime - startTime;
                durationDisplay.textContent = `é¸æŠç¯„å›²: ${duration.toFixed(2)}ç§’`;
            } else {
                durationDisplay.textContent = 'é¸æŠç¯„å›²: 0.00ç§’';
            }
        }
        /**
         * ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã¨é–¢é€£ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹é–¢æ•°
         */
        function setupSliderAndEvents() {
            const duration = videoPreview.duration;
            if (!duration || !isFinite(duration)) {
                // durationãŒä¸æ­£ãªå ´åˆã¯ä½•ã‚‚ã—ãªã„
                console.error("Invalid video duration:", duration);
                return;
            }
            currentVideoDuration = duration;

            // æ—¢ã«ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ç ´æ£„
            if (rangeSlider) {
                rangeSlider.destroy();
            }

            // å…¥åŠ›æ¬„ã‚’åˆæœŸåŒ–
            startTimeInput.value = "0.00";
            endTimeInput.value = ""; // æœ€å¾Œã¾ã§ãªã®ã§ç©ºã«ã™ã‚‹
            endTimeInput.placeholder = `å‹•ç”»ã®æœ€å¾Œã¾ã§ (${duration.toFixed(2)}s)`;

            // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’ç”Ÿæˆ
            rangeSlider = noUiSlider.create(sliderContainer, {
                start: [0, duration],
                connect: true,
                range: { 'min': 0, 'max': duration },
                tooltips: [
                    { to: value => parseFloat(value).toFixed(2) + 's' },
                    { to: value => parseFloat(value).toFixed(2) + 's' }
                ]
            });

            // --- ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã¨å…¥åŠ›æ¬„ã®åŒæ–¹å‘é€£æº ---
            rangeSlider.on('update', (values, handle) => {
                const startTime = parseFloat(values[0]);
                const endTime = parseFloat(values[1]);

                startTimeInput.value = startTime.toFixed(2);
                if (Math.abs(endTime - currentVideoDuration) < 0.1) {
                    endTimeInput.value = '';
                } else {
                    endTimeInput.value = endTime.toFixed(2);
                }
                // â˜…â˜…â˜… è¿½åŠ : ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼æ›´æ–°æ™‚ã«é¸æŠæ™‚é–“ã‚’è¡¨ç¤º â˜…â˜…â˜…
                updateDurationDisplay();
            });

            // --- ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã¨å‹•ç”»ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®é€£æº ---
            rangeSlider.on('slide', (values, handle) => {
                videoPreview.currentTime = parseFloat(values[handle]);
            });

            // --- å…¥åŠ›æ¬„ã‹ã‚‰ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã¸ã®é€£æº ---
            startTimeInput.addEventListener('change', function() {
                rangeSlider.set([this.value, null]);
                // â˜…â˜…â˜… è¿½åŠ : å…¥åŠ›æ¬„å¤‰æ›´æ™‚ã«é¸æŠæ™‚é–“ã‚’è¡¨ç¤º â˜…â˜…â˜…
                updateDurationDisplay();
            });

            endTimeInput.addEventListener('change', function() {
                rangeSlider.set([null, this.value === '' ? currentVideoDuration : this.value]);
                // â˜…â˜…â˜… è¿½åŠ : å…¥åŠ›æ¬„å¤‰æ›´æ™‚ã«é¸æŠæ™‚é–“ã‚’è¡¨ç¤º â˜…â˜…â˜…
                updateDurationDisplay();
            });

            // â˜…â˜…â˜… è¿½åŠ : ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ™‚ã«åˆæœŸè¡¨ç¤º â˜…â˜…â˜…
            updateDurationDisplay();
        }

        // â˜…â˜…â˜… ä¿®æ­£è¨ˆç”»æ¡ˆ ã‚¹ãƒ†ãƒƒãƒ—2 â˜…â˜…â˜…
        // 'loadedmetadata' ã‚¤ãƒ™ãƒ³ãƒˆã¯ã€å‹•ç”»ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ï¼ˆé•·ã•ã€ã‚µã‚¤ã‚ºãªã©ï¼‰ãŒ
        // èª­ã¿è¾¼ã¾ã‚ŒãŸã¨ãã«ç™ºç”Ÿã—ã¾ã™ã€‚ã“ã‚Œã¯ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’åˆæœŸåŒ–ã™ã‚‹ã®ã«æœ€ã‚‚ç¢ºå®Ÿãªã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã™ã€‚
        videoPreview.addEventListener('loadedmetadata', () => {
            // isSliderSetup ãƒ•ãƒ©ã‚°ã¯ã€æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã‚‹ãŸã³ã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚
            // ã“ã‚Œã«ã‚ˆã‚Šã€å‹•ç”»ã”ã¨ã«ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ãŒä¸€åº¦ã ã‘ä½œæˆã•ã‚Œã‚‹ã“ã¨ã‚’ä¿è¨¼ã—ã¾ã™ã€‚
            if (!isSliderSetup) {
                isSliderSetup = true;
                setupSliderAndEvents();
            }
        });

        // --- ã‚¹ãƒ†ãƒƒãƒ—B-1: UIã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®å¤‰æ›´ ---
        // ã€Œãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ...ã€ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚‰ã€Pythonã®APIã‚’å‘¼ã³å‡ºã™
        selectFileButton.addEventListener('click', async () => {
            // pywebviewã®APIã‚’å‘¼ã³å‡ºã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ã
            const filePath = await window.pywebview.api.select_file();
            if (filePath) {
                selectedFilePathInput.value = filePath;

                // ãƒ•ã‚¡ã‚¤ãƒ«åéƒ¨åˆ†ã‚’å–å¾—
                const fileName = filePath.split(/[\\/]/).pop();
                // ä¿å­˜ãƒ•ã‚¡ã‚¤ãƒ«åã‚’è‡ªå‹•ç”Ÿæˆ
                const lastDotIndex = fileName.lastIndexOf('.');
                const baseName = (lastDotIndex === -1) ? fileName : fileName.substring(0, lastDotIndex);
                outputFilenameInput.value = `${baseName}.gif`;

                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
                isSliderSetup = false;
                // ä»¥å‰ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒ createObjectURL ã§ä½œã‚‰ã‚ŒãŸã‚‚ã®ã§ã‚ã‚Œã°è§£æ”¾ã™ã‚‹
                if (videoPreview.src && videoPreview.src.startsWith('blob:')) {
                    URL.revokeObjectURL(videoPreview.src);
                }
                // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’ç›´æ¥ä½¿ã‚ãšã€ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆçµŒç”±ã§èª­ã¿è¾¼ã‚€
                videoPreview.src = `/load-video?path=${encodeURIComponent(filePath)}`;
                previewContainer.style.display = 'block';
            }
        });

        // ã€Œãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠ...ã€ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚‰ã€Pythonã®APIã‚’å‘¼ã³å‡ºã™
        selectDirButton.addEventListener('click', async () => {
            const folderPath = await window.pywebview.api.select_folder();
            if (folderPath) {
                outputDirInput.value = folderPath;
            }
        });

        // ã‚µãƒ¼ãƒãƒ¼ã«ã‚¿ã‚¹ã‚¯ã®çŠ¶æ³ã‚’å•ã„åˆã‚ã›ã‚‹é–¢æ•°
        function pollStatus(statusUrl) {
            const intervalId = setInterval(async () => {
                try {
                    const response = await fetch(statusUrl); // ã“ã“ã¯æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã§å¤‰æ›´ã—ã¾ã™
                    if (!response.ok) {
                        statusDiv.className = 'error';
                        statusDiv.textContent = `ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸ: ${response.statusText}`;
                        clearInterval(intervalId);
                        return;
                    }

                    const data = await response.json();

                    if (data.state === 'SUCCESS') { // â˜…â˜…â˜… ã‚¹ãƒ†ãƒƒãƒ—2: å¤‰æ›å®Œäº†å¾Œã®å‡¦ç†ã‚’åˆ†å² â˜…â˜…â˜…
                        clearInterval(intervalId);
                        progressContainer.style.display = 'none';
                        statusDiv.className = 'success';
                        resultDiv.innerHTML = ''; // ä»¥å‰ã®çµæœã‚’ã‚¯ãƒªã‚¢

                        if (data.is_desktop_app) {
                            // --- ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã‚¢ãƒ—ãƒªç‰ˆã®UI ---
                            statusDiv.textContent = `å¤‰æ›å®Œäº†ï¼ãƒ•ã‚¡ã‚¤ãƒ«ã¯æ­£å¸¸ã«ä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚`;
                            const openFolderBtn = document.createElement('button');
                            openFolderBtn.innerText = 'ä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€ã‚’é–‹ã';
                            openFolderBtn.style.marginTop = '10px';
                            openFolderBtn.onclick = async (e) => {
                                e.preventDefault();
                                try {
                                    // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã® /open-folder ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å‘¼ã³å‡ºã™
                                    await fetch('/open-folder', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ path: data.output_path })
                                    });
                                } catch (err) {
                                    alert('ãƒ•ã‚©ãƒ«ãƒ€ã‚’é–‹ã‘ã¾ã›ã‚“ã§ã—ãŸã€‚');
                                }
                            };
                            resultDiv.appendChild(openFolderBtn);
                        } else {
                            // --- Webã‚¢ãƒ—ãƒªç‰ˆã®UI (ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯) ---
                            statusDiv.textContent = 'å¤‰æ›ãŒå®Œäº†ã—ã¾ã—ãŸï¼';
                            const gifResponse = await fetch(data.download_url);
                            const blob = await gifResponse.blob();
                            const objectURL = URL.createObjectURL(blob);
                            resultDiv.innerHTML = `<img src="${objectURL}" alt="Converted GIF"><br><a href="${objectURL}" download="converted.gif">GIFã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</a>`;
                        }

                    } else if (data.state === 'FAILURE') {
                        clearInterval(intervalId);
                        progressContainer.style.display = 'none';
                        statusDiv.className = 'error';
                        statusDiv.textContent = `ã‚¨ãƒ©ãƒ¼: å¤‰æ›ã«å¤±æ•—ã—ã¾ã—ãŸã€‚è©³ç´°: ${data.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`;
                    } else if (data.state === 'PROGRESS') {
                        statusDiv.textContent = `å¤‰æ›ä¸­ã§ã™... ${data.progress}%`;
                        progressBar.value = data.progress;
                        progressContainer.style.display = 'block';
                    } else {
                        // PENDING, STARTED, RETRY...
                        progressContainer.style.display = 'none';
                        statusDiv.className = 'info';
                        statusDiv.textContent = `å¤‰æ›ä¸­ã§ã™... (ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${data.state})`;
                    }
                } catch (error) {
                    statusDiv.className = 'error';
                    statusDiv.textContent = `ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ç¢ºèªä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error}`;
                    clearInterval(intervalId);
                }
            }, 2000); // 2ç§’ã”ã¨ã«çŠ¶æ³ã‚’ç¢ºèª
        }

        form.addEventListener('submit', async (e) => { // â˜…â˜…â˜… ã‚¹ãƒ†ãƒƒãƒ—B-2: é€ä¿¡å‡¦ç†ã‚’JSONã«å¤‰æ›´ â˜…â˜…â˜…
            e.preventDefault();

            const payload = {
                input_path: document.getElementById('selected-file-path').value,
                output_dir: document.getElementById('output-dir').value,
                output_filename: document.getElementById('output-filename').value,
                start_time: document.getElementById('start_time').value,
                end_time: document.getElementById('end_time').value,
                fps: document.getElementById('fps').value,
                width: document.getElementById('width').value,
                high_quality: document.getElementById('high_quality').checked
            };

            if (!payload.input_path) {
                alert('å¤‰æ›ã™ã‚‹MP4ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            statusDiv.style.display = 'block';
            statusDiv.className = 'info';
            statusDiv.textContent = 'å¤‰æ›ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¦ã„ã¾ã™...';
            progressContainer.style.display = 'none';
            progressBar.value = 0;
            resultDiv.innerHTML = '';

            try {
                const response = await fetch('/convert', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (response.status === 202) {
                    const data = await response.json();
                    statusDiv.textContent = 'å¤‰æ›ã‚¿ã‚¹ã‚¯ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸã€‚å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™...';
                    pollStatus(data.status_url);
                } else {
                    const errorData = await response.json();
                    statusDiv.className = 'error';
                    statusDiv.textContent = `ã‚¨ãƒ©ãƒ¼: ${errorData.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`;
                }
            } catch (error) {
                statusDiv.className = 'error';
                statusDiv.textContent = `ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error}`;
            }
        });
    });
    </script>
    <footer style="text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 14px; color: #6c757d;">
        <p>Powered by Open Source Software. <a href="/licenses">Licenses</a></p>
    </footer>
</body>
</html>